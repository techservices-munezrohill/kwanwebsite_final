const axios = require('axios');

exports.handler = async (event) => {
  const { code } = event.queryStringParameters || {};

  // Step 1: Redirect to GitHub if no code
  if (!code) {
    const authUrl = `https://github.com/login/oauth/authorize?client_id=${process.env.OAUTH_CLIENT_ID}&redirect_uri=${encodeURIComponent(process.env.URL + '/.netlify/functions/auth')}&scope=repo,user`;
    return {
      statusCode: 302,
      headers: {
        Location: authUrl,
      },
    };
  }

  // Step 2: Handle GitHub callback with code
  try {
    const { data } = await axios.post(
      'https://github.com/login/oauth/access_token',
      {
        client_id: process.env.OAUTH_CLIENT_ID,
        client_secret: process.env.OAUTH_CLIENT_SECRET,
        code,
      },
      {
        headers: { Accept: 'application/json' },
      }
    );

    const accessToken = data.access_token;

    if (!accessToken) {
      throw new Error('No access token returned from GitHub');
    }

    // Step 3: Return a small HTML page that safely passes the token to Netlify CMS popup
    const html = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Authorization successful</title>
        </head>
        <body>
          <script>
            // Netlify CMS expects CMSOAuthCallback for popup login
            if (window.opener && window.opener.CMSOAuthCallback) {
              window.opener.CMSOAuthCallback("${accessToken}");
            } else {
              console.error('CMSOAuthCallback not found on opener window');
            }
            window.close();
          </script>
        </body>
      </html>
    `;

    return {
      statusCode: 200,
      headers: {
        'Content-Type': 'text/html',
      },
      body: html,
    };
  } catch (err) {
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'GitHub authentication failed', details: err.message }),
    };
  }
};
